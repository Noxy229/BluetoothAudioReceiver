name: Auto Release on Bot Merge

on:
  pull_request:
    types: [closed]
    branches: [master, main]

permissions:
  contents: write

jobs:
  build-and-release:
    # Nur ausfÃ¼hren wenn ein PR gemerged wurde UND vom Bot erstellt wurde
    if: github.event.pull_request.merged == true && github.event.pull_request.user.login == 'google-labs-jules[bot]'
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Generate Cert Password
      run: |
        $password = [Guid]::NewGuid().ToString()
        echo "PFX_PASSWORD=$password" >> $env:GITHUB_ENV
      shell: powershell

    - name: Create Test Certificate
      run: |
        .\scripts\Create-Test-Cert.ps1 -CertPassword $env:PFX_PASSWORD
      shell: powershell

    - name: Build and Sign
      run: |
        .\scripts\Sign-Build.ps1 -CertPassword $env:PFX_PASSWORD
      shell: powershell

    - name: Generate version tag
      id: version
      run: |
        $timestamp = Get-Date -Format "yyyy.MM.dd.HHmm"
        $prNumber = "${{ github.event.pull_request.number }}"
        $tag = "v$timestamp-pr$prNumber"
        echo "tag=$tag" >> $env:GITHUB_OUTPUT
        echo "Generated tag: $tag"
      shell: powershell

    - name: Create Release with EXE
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: "Auto-Release: ${{ github.event.pull_request.title }}"
        body: |
          ðŸ¤– **Automatisch erstellt nach Bot-Merge**
          
          **PR:** #${{ github.event.pull_request.number }}
          **Titel:** ${{ github.event.pull_request.title }}
        files: |
          bin/Release/net8.0-windows10.0.19041.0/publish/BluetoothAudioReceiver.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
